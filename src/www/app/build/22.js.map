{"version":3,"sources":["../../src/pages/ratings/ratings.module.ts","../../src/pages/ratings/ratings.ts"],"names":[],"mappings":"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","file":"22.js","sourcesContent":["import { NgModule } from '@angular/core';\nimport { IonicPageModule } from 'ionic-angular';\nimport { RatingsPage } from './ratings';\nimport { Ionic2RatingModule } from 'ionic2-rating';\n\n@NgModule({\n  declarations: [\n    RatingsPage,\n  ],\n  imports: [\n    IonicPageModule.forChild(RatingsPage),\n    Ionic2RatingModule,\n  ],\n})\nexport class RatingsPageModule {}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/ratings/ratings.module.ts","import { Component } from '@angular/core';\nimport { IonicPage, NavController, NavParams, ToastController, ViewController } from 'ionic-angular';\nimport { BackProvider } from '../../providers/back/back';\nimport { contentRatings } from '../../app/app.config';\nimport { Observable } from 'rxjs';\nimport { Rating, Collections, Content } from '../../app/app.models';\nimport { AngularFirestore } from 'angularfire2/firestore';\nimport { AuthProvider } from '../../providers/auth/auth';\nimport { DataProvider } from '../../providers/data/data';\nimport { take, map } from 'rxjs/operators';\n\n@IonicPage()\n@Component({\n  selector: 'page-ratings',\n  templateUrl: 'ratings.html',\n})\nexport class RatingsPage {\n\n  private clase: any\n  private id: string = this.navParams.get('id')\n  private type: string = this.navParams.get('type')\n\n  public content: Content;\n\n  public contentRatings = [...contentRatings];\n  public ratingsModel = {};\n\n  private ratingKey: string;\n  public rating$: Observable<Rating>;\n\n  constructor(\n    public navCtrl: NavController,\n    public navParams: NavParams,\n    private back: BackProvider,\n    private toast: ToastController,\n    public viewCtrl: ViewController,\n    private afs: AngularFirestore,\n    private auth: AuthProvider,\n    private data: DataProvider,\n  ) {\n  }\n\n  ionViewDidLoad() {\n\n    this.loadRatings();\n    this.loadContent();\n\n    /* this.back.getClase(this.id, this.type).subscribe(data => {\n      this.clase = data\n      this.clase.c = data.ratings ? data.ratings[this.back.uid] ? data.ratings[this.back.uid].c : 0 : 0\n      this.clase.d = data.ratings ? data.ratings[this.back.uid] ? data.ratings[this.back.uid].d : 0 : 0\n      this.clase.e = data.ratings ? data.ratings[this.back.uid] ? data.ratings[this.back.uid].e : 0 : 0\n    },\n    err => {\n      this.toast.create({message: 'No se pudo cargar la calificación de la clase...', duration: 2000}).present()\n      if (this.navCtrl.canGoBack()) this.navCtrl.pop()\n    }) */\n\n  }\n\n  saveRating(e) {\n\n    if (!this.clase.ratings) this.clase.ratings = {}\n    if (!this.clase.ratings[this.back.uid]) this.clase.ratings[this.back.uid] = {}\n\n    this.clase.ratings[this.back.uid].c = this.clase.c\n    this.clase.ratings[this.back.uid].d = this.clase.d\n    this.clase.ratings[this.back.uid].e = this.clase.d\n\n    this.back.updateClase(this.id, this.type, {ratings: this.clase.ratings}).subscribe(data => console.log, err => this.toast.create({message: 'No se pudo actualizar tu calificación...', duration: 2000}).present())\n\n  }\n\n  async loadContent() {\n    this.content = await this.data.getDocAlt<Content>(Collections.CONTENT, this.id);\n  }\n\n  loadRatings() {\n\n    this.auth.user$.subscribe(user => {\n\n      if (!user && !this.rating$) { return; }\n      // console.log(this.parent_type, this.parent_id, this.content_type, this.content)\n\n      // Generates the key for the userRating\n      this.ratingKey = `${this.id}-${user.uid}`;\n      this.rating$ = this.afs.doc<Rating>(`${Collections.RATING}/${this.ratingKey}`).valueChanges();\n\n      // This loads the current user rating for the specific content\n      this.rating$.subscribe(ratings => {\n        this.ratingsModel = ratings ? ratings : { id: this.ratingKey };\n      });\n\n    });\n\n  }\n\n  async updateRating(key: string, value: number) {\n\n    if (isNaN(value)) { return; }\n    console.log(`updateing rating \"${key}\" to \"${value}\"`);\n\n    const content = await this.afs.doc<Content>(`${Collections.CONTENT}/${this.id}`).valueChanges().pipe(take(1)).toPromise();\n    if (!content.totalRatings) { content.totalRatings = 0; }\n    if (!content.ratings) { content.ratings = {}; }\n    if (!content.ratings[key]) { content.ratings[key] = 0; }\n\n    content.totalRatings++;\n    // content.ratings[key] = (content.ratings[key] + value) / content.totalRatings\n\n    console.log({\n      id: this.ratingKey,\n      [key]: value,\n      parent: this.id\n    });\n\n    await this.afs.doc(`${Collections.RATING}/${this.ratingKey}`).set({\n      id: this.ratingKey,\n      [key]: value,\n      parent: this.id\n    }, { merge: true });\n\n    /* this.toastr.success('Gracias por tu calificación.'); */\n\n    // Calculate rating every update (might not be the best idea until we find another thing)\n    this.afs.collection<Rating>(Collections.RATING, ref => ref\n      .where('parent', '==', this.id))\n      .valueChanges()\n      .pipe(\n        map(ratings => ratings.map(r => r[key]).reduce((a, b) => a + b, 0) / ratings.length),\n      ).subscribe(rating => {\n        content.ratings[key] = parseFloat(rating.toString());\n        this.afs.doc(`${Collections.CONTENT}/${this.id}`).update({ ratings: content.ratings, totalRatings: content.totalRatings });\n      });\n\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/ratings/ratings.ts"],"sourceRoot":""}