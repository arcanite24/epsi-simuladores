{"version":3,"sources":["../../src/pages/ratings/ratings.module.ts","../../src/pages/ratings/ratings.ts"],"names":[],"mappings":"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","file":"19.js","sourcesContent":["import { NgModule } from '@angular/core';\nimport { IonicPageModule } from 'ionic-angular';\nimport { RatingsPage } from './ratings';\nimport { Ionic2RatingModule } from 'ionic2-rating';\n\n@NgModule({\n  declarations: [\n    RatingsPage,\n  ],\n  imports: [\n    IonicPageModule.forChild(RatingsPage),\n    Ionic2RatingModule,\n  ],\n})\nexport class RatingsPageModule {}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/ratings/ratings.module.ts","import { Component } from '@angular/core';\nimport { IonicPage, NavController, NavParams, ToastController, ViewController } from 'ionic-angular';\nimport { BackProvider } from '../../providers/back/back';\nimport { contentRatings } from '../../app/app.config';\nimport { Observable } from 'rxjs';\nimport { Rating, Collections, Content } from '../../app/app.models';\nimport { AngularFirestore } from 'angularfire2/firestore';\nimport { AuthProvider } from '../../providers/auth/auth';\nimport { DataProvider } from '../../providers/data/data';\nimport { take, map } from 'rxjs/operators';\n\n@IonicPage()\n@Component({\n  selector: 'page-ratings',\n  templateUrl: 'ratings.html',\n})\nexport class RatingsPage {\n\n  private clase: any\n  private id: string = this.navParams.get('id')\n  private type: string = this.navParams.get('type')\n\n  public content: Content;\n\n  public contentRatings = [...contentRatings];\n  public ratingsModel = {};\n\n  private ratingKey: string;\n  public rating$: Observable<Rating>;\n\n  constructor(\n    public navCtrl: NavController,\n    public navParams: NavParams,\n    private back: BackProvider,\n    private toast: ToastController,\n    public viewCtrl: ViewController,\n    private afs: AngularFirestore,\n    private auth: AuthProvider,\n    private data: DataProvider,\n  ) {\n  }\n\n  ionViewDidLoad() {\n\n    this.loadContent();\n\n    /* this.back.getClase(this.id, this.type).subscribe(data => {\n      this.clase = data\n      this.clase.c = data.ratings ? data.ratings[this.back.uid] ? data.ratings[this.back.uid].c : 0 : 0\n      this.clase.d = data.ratings ? data.ratings[this.back.uid] ? data.ratings[this.back.uid].d : 0 : 0\n      this.clase.e = data.ratings ? data.ratings[this.back.uid] ? data.ratings[this.back.uid].e : 0 : 0\n    },\n    err => {\n      this.toast.create({message: 'No se pudo cargar la calificación de la clase...', duration: 2000}).present()\n      if (this.navCtrl.canGoBack()) this.navCtrl.pop()\n    }) */\n\n  }\n\n  saveRating(e) {\n\n    if (!this.clase.ratings) this.clase.ratings = {}\n    if (!this.clase.ratings[this.back.uid]) this.clase.ratings[this.back.uid] = {}\n\n    this.clase.ratings[this.back.uid].c = this.clase.c\n    this.clase.ratings[this.back.uid].d = this.clase.d\n    this.clase.ratings[this.back.uid].e = this.clase.d\n\n    this.back.updateClase(this.id, this.type, {ratings: this.clase.ratings}).subscribe(data => console.log, err => this.toast.create({message: 'No se pudo actualizar tu calificación...', duration: 2000}).present())\n\n  }\n\n  async loadContent() {\n    this.content = await this.data.getDocAlt<Content>(Collections.CONTENT, this.id);\n  }\n\n  loadRatings() {\n\n    this.auth.user$.subscribe(user => {\n\n      if (!user && !this.rating$) { return; }\n      // console.log(this.parent_type, this.parent_id, this.content_type, this.content)\n\n      // Generates the key for the userRating\n      this.ratingKey = `${this.id}-${user.uid}`;\n      this.rating$ = this.afs.doc<Rating>(`${Collections.RATING}/${this.ratingKey}`).valueChanges();\n\n      // This loads the current user rating for the specific content\n      this.rating$.subscribe(ratings => {\n        this.ratingsModel = ratings ? ratings : { id: this.ratingKey };\n      });\n\n    });\n\n  }\n\n  async updateRating(key: string, value: number) {\n\n    if (isNaN(value)) { return; }\n    console.log(`updateing rating \"${key}\" to \"${value}\"`);\n\n    const content = await this.afs.doc<Content>(`${Collections.CONTENT}/${this.id}`).valueChanges().pipe(take(1)).toPromise();\n    if (!content.totalRatings) { content.totalRatings = 0; }\n    if (!content.ratings) { content.ratings = {}; }\n    if (!content.ratings[key]) { content.ratings[key] = 0; }\n\n    content.totalRatings++;\n    // content.ratings[key] = (content.ratings[key] + value) / content.totalRatings\n\n    await this.afs.doc(`${Collections.RATING}/${this.ratingKey}`).set({\n      id: this.ratingKey,\n      [key]: value,\n      parent: this.id\n    }, { merge: true });\n\n    /* this.toastr.success('Gracias por tu calificación.'); */\n\n    // Calculate rating every update (might not be the best idea until we find another thing)\n    this.afs.collection<Rating>(Collections.RATING, ref => ref\n      .where('parent', '==', this.id))\n      .valueChanges()\n      .pipe(\n        map(ratings => ratings.map(r => r[key]).reduce((a, b) => a + b, 0) / ratings.length),\n      ).subscribe(rating => {\n        content.ratings[key] = parseFloat(rating.toString());\n        this.afs.doc(`${Collections.CONTENT}/${this.id}`).update({ ratings: content.ratings, totalRatings: content.totalRatings });\n      });\n\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/ratings/ratings.ts"],"sourceRoot":""}